<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Funnel</title>
    <style>
        html {
            font-size: calc(100vw/3.75);
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #222653;
        }
        .funnel {
            position: absolute;
            top:0;bottom:0;left:0;right:0;
            margin: 100px auto;
            width: 3rem; height: 4rem;
        }
    </style>
</head>
<body>
    <div class="funnel">
        <canvas id="funnel" width="600" height="800" style="width: 3rem; height: 4rem;"></canvas>
    </div>
<script>
var data = [
        {
        	title: '董事长/创始人',
            value: 13
        },
        {
        	title: '总监/经理',
            value: 34
        },
        {
        	title: '助理/专员执行人员',
            value: 53
        }
    ],
    options = {
	    title: {
	    	fontSize: 15,
            color: '#ffffff'
        },
        value: {
	    	fontSize: 20,
            color: '#23E7DD'
        },
        maxValue: 100,
        minValue: 0
    },
    funnel = Funnel('funnel', data).render(options);

function Funnel(domID, data) {
    var instance = {},
        canvas = document.getElementById(domID),
        ctx = canvas.getContext('2d'),
        width = canvas.width,
        height = canvas.height,
        pyramid_l = height * 0.6, // 正四棱锥的棱长
        pyramid_h = height / (Math.sqrt(2)), // 正四棱锥高
        top_ang = Math.PI * 7 / 36,
        bottom_ang = Math.PI / 9;
	data = data || {};
    ctx.translate(canvas.width/2, 0);

    function _heightRatio() {
        if(!data) return;
        var total = 0, a_ratio = [];
        data.forEach(function(item, key) {
            total += item.value;
            a_ratio[key] = item.value / 100;
        });
        if(total != 100) {
            console.log('数据比例错误!');
            return;
        }
        return a_ratio;
    }
    function _renderTop(ratio) {
        if(!ratio) return;
        var top_l = (+ratio) * pyramid_l, // 顶部棱长
            top_h = top_l * Math.cos(top_ang) + top_l * Math.sin(top_ang) * Math.tan(bottom_ang), //顶部高
            point_left = [-top_l * Math.sin(top_ang), top_l * Math.cos(top_ang)],
            point_middle = [0, top_h],
            point_right = [top_l * Math.sin(top_ang), top_l * Math.cos(top_ang)];

        instance.top_length = top_l;
        instance.top_height = top_h;
        instance.top_b_l = top_l * Math.sin(top_ang);
        instance.shadow_length = top_h / (4 * Math.sqrt(2));

        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(point_left[0], point_left[1]);
        ctx.lineTo(point_middle[0], point_middle[1]);
        ctx.lineTo(0, 0);
        ctx.closePath();
        ctx.fillStyle = 'rgba(123, 190, 94, 1)';
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(point_right[0], point_right[1]);
        ctx.lineTo(point_middle[0], point_middle[1]);
        ctx.lineTo(0, 0);
        ctx.closePath();
        ctx.fillStyle = 'rgba(103, 169, 101, 1)';
        ctx.fill();

        // 顶部阴影
//        ctx.beginPath();
//        ctx.moveTo(0, point_middle_y - 18);
//        ctx.lineTo(point_left_x + 30, point_left_y + 11);
//        // ctx.lineTo();
//        ctx.closePath();
//        ctx.strokeStyle = 'rgba(44, 133, 144, 1)';
//        ctx.stroke();
        ctx.translate(0, top_l);
    }

    function _renderMiddle(ratio) {
        if(!ratio) return;
        var middle_l = (+ratio) * pyramid_l,
            middle_h = middle_l * Math.cos(top_ang) + middle_l * Math.sin(top_ang) * Math.tan(bottom_ang),
            start_height_fix = instance.top_b_l * Math.sin(bottom_ang),
            point_left_top = [-instance.top_b_l, 0],
            point_left_bottom = [-(middle_l * Math.sin(top_ang) + instance.top_b_l), middle_l * Math.cos(top_ang)],
            point_middle = [0, middle_h],
            point_right_top = [instance.top_b_l, 0],
            point_right_bottom = [middle_l * Math.sin(top_ang) + instance.top_b_l, middle_l * Math.cos(top_ang)];

        instance.middle_length = middle_l;
        instance.middle_height = middle_h;
	    instance.middle_b_l = middle_l * Math.sin(top_ang) + instance.top_b_l;

        ctx.beginPath();
        ctx.moveTo(0, start_height_fix);
        ctx.lineTo(point_left_top[0], point_left_top[1]);
        ctx.lineTo(point_left_bottom[0], point_left_bottom[1]);
        ctx.lineTo(point_middle[0], point_middle[1]);
        ctx.lineTo(0, start_height_fix);
        ctx.closePath();
        ctx.fillStyle = 'rgba(51, 162, 150, 1)';
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(0, start_height_fix);
        ctx.lineTo(point_right_top[0], point_right_top[1]);
        ctx.lineTo(point_right_bottom[0], point_right_bottom[1]);
        ctx.lineTo(point_middle[0], point_middle[1]);
        ctx.lineTo(0, start_height_fix);
        ctx.closePath();
        ctx.fillStyle = 'rgba(45, 146, 148, 1)';
        ctx.fill();

        ctx.translate(0, middle_l);
    }

    function _renderThird(ratio) {
        if(!ratio) return;
        var third_l = (+ratio) * pyramid_l,
            third_h = third_l * Math.cos(top_ang) + third_l * Math.sin(top_ang) * Math.tan(bottom_ang),
	        start_height_fix = instance.middle_b_l * Math.sin(bottom_ang),
	        point_left_top = [-instance.middle_b_l, 0],
	        point_left_bottom = [-(third_l * Math.sin(top_ang) + instance.middle_b_l), third_l * Math.cos(top_ang)],
	        point_middle = [0, third_h],
	        point_right_top = [instance.middle_b_l, 0],
	        point_right_bottom = [third_l * Math.sin(top_ang) + instance.middle_b_l, third_l * Math.cos(top_ang)],

            shadow_length = instance.shadow_length,
            middle_section_h = instance.middle_length / 2;

        ctx.beginPath();
        ctx.moveTo(0, start_height_fix);
        ctx.lineTo(point_left_top[0], point_left_top[1]);
        ctx.lineTo(point_left_bottom[0], point_left_bottom[1]);
        ctx.lineTo(point_middle[0], point_middle[1]);
        ctx.lineTo(0, start_height_fix);
        ctx.closePath();
        ctx.fillStyle = 'rgba(17, 122, 176, 1)';
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(0, start_height_fix);
        ctx.lineTo(point_right_top[0], point_right_top[1]);
        ctx.lineTo(point_right_bottom[0], point_right_bottom[1]);
        ctx.lineTo(point_middle[0], point_middle[1]);
        ctx.lineTo(0, start_height_fix);
        ctx.closePath();
        ctx.fillStyle = 'rgba(17, 107, 159, 1)';
        ctx.fill();
        ctx.translate(0, third_l);
    }

    function _renderBottom() {
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(-265, -80);
        ctx.lineTo(-278, -60);
        ctx.lineTo(0 , 26);
        ctx.lineTo(0, 0);
        ctx.closePath();
        ctx.fillStyle = 'rgba(22, 60, 134, 1)';
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(265, -80);
        ctx.lineTo(278, -60);
        ctx.lineTo(0 , 26);
        ctx.lineTo(0, 0);
        ctx.closePath();
        ctx.fillStyle = 'rgba(20, 46, 129, 1)';
        ctx.fill();
    }

    instance.render = function(options) {
        var a_ratio = _heightRatio() || [];
        if(!a_ratio) return;
        a_ratio.forEach(function(item) {
            if(!item) return;
        });
        _renderTop(a_ratio[0]);
        _renderMiddle(a_ratio[1]);
        _renderThird(a_ratio[2]);
        // _renderBottom();
        return instance;
    };
    return instance;
}
</script>
</body>
</html>
